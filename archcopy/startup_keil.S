; Ensure there is a space/tab before 'AREA'
        AREA    RESET, CODE, READONLY    ; Section name is RESET
        ARM                              ; 32-bit ARM mode
        CODE32
        PRESERVE8                        ; 8-byte stack alignment

; ========================================================
; NAND/NOR Boot + SDRAM Init + Vector Table
; Target: mini2440 (S3C2440)
; ========================================================

        EXPORT  _start
        EXPORT  Reset_Handler

        IMPORT  main
        IMPORT  OSTickISR
        
        ; Symbols generated by linker for ZI (BSS) section
        IMPORT  |Image$$RW_RAM1$$ZI$$Base|
        IMPORT  |Image$$RW_RAM1$$ZI$$Limit|
        ; Symbols for RW (initialized data) copy from load to exec
        IMPORT  |Image$$RW_RAM1$$Base|
        IMPORT  |Image$$RW_RAM1$$Length|
        IMPORT  |Load$$RW_RAM1$$Base|

; ========================================================
; Register Definitions
; ========================================================
WTCON       EQU     0x53000000
BWSCON      EQU     0x48000000
BANKCON6    EQU     0x4800001C
REFRESH     EQU     0x48000024
BANKSIZE    EQU     0x48000028
MRSRB6      EQU     0x4800002C
LOCKTIME    EQU     0x4C000000
MPLLCON     EQU     0x4C000004
UPLLCON     EQU     0x4C000008
CLKCON      EQU     0x4C00000C
CLKDIVN     EQU     0x4C000014
INTMSK      EQU     0x4A000008

; ========================================================
; Exception Vector Table
; ========================================================
_start
        B       Reset_Handler
        B       Undefined_Handler
        B       SWI_Handler
        B       Prefetch_Handler
        B       Abort_Handler
        B       .
        B       IRQ_Handler
        B       FIQ_Handler

Undefined_Handler
        B       Undefined_Handler
SWI_Handler
        B       SWI_Handler
Prefetch_Handler
        B       Prefetch_Handler
Abort_Handler
        B       Abort_Handler
FIQ_Handler
        B       FIQ_Handler

IRQ_Handler
        B       OSTickISR

; ========================================================
; Reset Handler
; ========================================================
Reset_Handler

; 1. Disable Watchdog Timer
        LDR     r0, =WTCON
        MOV     r1, #0
        STR     r1, [r0]

; 2. Mask All Interrupts
        LDR     r0, =INTMSK
        LDR     r1, =0xFFFFFFFF
        STR     r1, [r0]

; 3. Configure Clock (FCLK:400MHz, HCLK:100MHz, PCLK:50MHz)
        LDR     r0, =LOCKTIME
        LDR     r1, =0xFFFFFFFF
        STR     r1, [r0]

        LDR     r0, =CLKDIVN
        MOV     r1, #5
        STR     r1, [r0]

        LDR     r0, =UPLLCON
        LDR     r1, =((56<<12)+(2<<4)+2)
        STR     r1, [r0]

        NOP
        NOP
        NOP

        LDR     r0, =MPLLCON
        LDR     r1, =((127<<12)+(2<<4)+1)
        STR     r1, [r0]

; 4. Initialize External SDRAM Controller
        LDR     r0, =BWSCON
        LDR     r1, =0x22000000
        STR     r1, [r0]

        LDR     r0, =BANKCON6
        LDR     r1, =0x18001
        STR     r1, [r0]

        LDR     r0, =BANKSIZE
        LDR     r1, =0xB1
        STR     r1, [r0]

        LDR     r0, =REFRESH
        LDR     r1, =0x8404F5
        STR     r1, [r0]

        LDR     r0, =MRSRB6
        LDR     r1, =0x20
        STR     r1, [r0]

; 5. Relocation: Copy image from 0x0 to SDRAM (0x30000000)
        MOV     r0, pc
        LDR     r1, =0x30000000
        CMP     r0, r1
        BHS     CodeInSDRAM

        LDR     r0, =_start
        LDR     r1, =0x30000000
        LDR     r2, =Image_End
        SUB     r2, r2, r0

CopyLoop
        LDR     r3, [r0], #4
        STR     r3, [r1], #4
        SUBS    r2, r2, #4
        BGT     CopyLoop

        LDR     pc, =CodeInSDRAM

; ========================================================
; Running in SDRAM
; ========================================================
CodeInSDRAM

; 6. Copy initialized RW data from load region to SDRAM exec region
        LDR     r0, =|Image$$RW_RAM1$$Base|    ; destination (exec in SDRAM)
        LDR     r1, =|Load$$RW_RAM1$$Base|     ; source (load in ROM/Flash)
        LDR     r2, =|Image$$RW_RAM1$$Length|  ; length in bytes
CopyRW
        CMP     r2, #0
        BEQ     CopyRWDone
        LDR     r3, [r1], #4
        STR     r3, [r0], #4
        SUB     r2, r2, #4
        B       CopyRW
CopyRWDone

; 7. Manual Zero-Initialization of BSS (ZI) Section
        LDR     r0, =|Image$$RW_RAM1$$ZI$$Base|
        LDR     r1, =|Image$$RW_RAM1$$ZI$$Limit|
        MOV     r2, #0
ZeroBSS
        CMP     r0, r1
        STRCC   r2, [r0], #4
        BCC     ZeroBSS

; 8. Set Stack Pointer for SVC Mode
SVCStack        EQU     0x33FFFFF0
SVCMODE         EQU     0x13
MODEMASK        EQU     0x1F

        MRS     r0, cpsr
        BIC     r0, r0, #MODEMASK
        ORR     r0, r0, #SVCMODE
        MSR     cpsr_c, r0
        LDR     sp, =SVCStack

; 9. Install Exception Vector Table to Physical Address 0x0
        LDR     r0, =0x00000000
        LDR     r1, =0xE59FF018  ; Instruction: LDR PC, [PC, #24]
        MOV     r2, #8
VecInst
        STR     r1, [r0], #4
        SUBS    r2, r2, #1
        BGT     VecInst

        LDR     r0, =0x00000020
        ADR     r1, _start       ; Map to the entry in SDRAM
        STR     r1, [r0], #4     ; Reset
        LDR     r1, =Undefined_Handler
        STR     r1, [r0], #4
        LDR     r1, =SWI_Handler
        STR     r1, [r0], #4
        LDR     r1, =Prefetch_Handler
        STR     r1, [r0], #4
        LDR     r1, =Abort_Handler
        STR     r1, [r0], #4
        MOV     r1, #0           ; Reserved
        STR     r1, [r0], #4
        LDR     r1, =IRQ_Handler
        STR     r1, [r0], #4
        LDR     r1, =FIQ_Handler
        STR     r1, [r0], #4

; 10. Jump to C Main
        BL      main

Stop
        B       Stop

Image_End
        END